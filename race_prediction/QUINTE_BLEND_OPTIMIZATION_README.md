# Quinté Blend Optimization

This script tests different RF/TabNet blend weights **from existing prediction files** to find the optimal combination for quinté predictions.

## Overview

The optimizer:
1. Loads predictions from existing CSV/JSON file (generated by `predict_quinte.py`)
2. Loads actual results from database
3. Tests different weight combinations (RF weight from 0.0 to 1.0, TabNet weight = 1.0 - RF weight)
4. Re-blends predictions for each weight combination
5. Calculates performance metrics:
   - **Quinté Désordre**: All 5 predicted horses finish in top 5 (any order)
   - **Bonus 3**: All 3 actual top finishers are in predicted top 5
   - **Bonus 4**: All 4 actual top finishers are in predicted top 5
   - **MAE**: Mean Absolute Error
   - **Avg horses in quinté**: Average number of predicted horses that finish in top 5
6. Ranks blends by performance

**Key Advantage**: Very fast! No need to re-run models - just re-blends existing predictions.

## Prerequisites

You must first generate quinté predictions with both RF and TabNet:

```bash
python race_prediction/predict_quinte.py
```

This creates a file like `predictions/quinte_predictions_all_2025-09-23_to_2025-10-10_TIMESTAMP.csv` with columns:
- `rf_predicted_position`
- `tabnet_predicted_position`
- `predicted_rank` (current blend)

## Usage

### Basic Usage (auto-finds latest prediction file)
```bash
python race_prediction/optimize_quinte_blend.py
```

### Use specific prediction file
```bash
python race_prediction/optimize_quinte_blend.py \
    --predictions predictions/quinte_predictions_all_2025-09-23_to_2025-10-10_20251010_231758.csv
```

### Use finer-grained weight steps (0.05 instead of 0.1)
```bash
python race_prediction/optimize_quinte_blend.py --step 0.05
```

### Custom output directory
```bash
python race_prediction/optimize_quinte_blend.py --output blend_results
```

## Output

The script generates:
1. **CSV file**: `predictions/quinte_blend_optimization_YYYYMMDD_HHMMSS.csv`
   - Contains results for all tested blends
   - Sorted by quinté désordre percentage (best first)

2. **Console output**: Summary of top 10 blends and the best overall blend

## Performance Notes

- Testing 11 blends (step=0.1) on 50 races takes **~1-2 seconds** (very fast!)
- Testing 21 blends (step=0.05) takes **~2-4 seconds**
- Testing 101 blends (step=0.01) takes **~10-15 seconds**

Much faster than re-running models since we just re-blend existing predictions!
